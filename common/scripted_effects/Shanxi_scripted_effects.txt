#阎锡山军事精神
SHX_upgrade_xiang_jun_model_spirit_effect = {
	if = {
		limit = { has_idea = SHX_xiang_jun_model_idea_1 } #Fallback in case somehow the player made it to phase 4 without taking army tree
		swap_ideas = {
			remove_idea = SHX_xiang_jun_model_idea_1
			add_idea = SHX_xiang_jun_model_idea_2
		}
	}
	else_if = {
		limit = { has_idea = SHX_xiang_jun_model_idea_2 }
		swap_ideas = {
			remove_idea = SHX_xiang_jun_model_idea_2
			add_idea = SHX_xiang_jun_model_idea_3
		}
	}
	else_if = {
		limit = { has_idea = SHX_xiang_jun_model_idea_3 }
		swap_ideas = {
			remove_idea = SHX_xiang_jun_model_idea_3
			add_idea = 	SHX_xiang_jun_model_idea_4
		}
	}
	else_if = {
		limit = { has_idea = SHX_xiang_jun_model_idea_4 }
		swap_ideas = {
			remove_idea = SHX_xiang_jun_model_idea_4
			add_idea = SHX_xiang_jun_model_idea_5
		}
	}
	else_if = {
		limit = { has_idea = SHX_xiang_jun_model_idea_5 } #Fallback
		every_unit_leader = {
			gain_xp = 200
		}
	}
	else = {
		custom_effect_tooltip = SHX_upgrade_xiang_jun_model_spirit_effect_tt
	}
	SHX_strengthen_yan_medium = yes
}
#冯玉祥军事精神
SHX_upgrade_guominjun_model_spirit_effect = {
	if = {
		limit = { has_idea = SHX_guominjun_model_idea } #Fallback in case somehow the player made it to phase 4 without taking army tree
		swap_ideas = {
			remove_idea = SHX_guominjun_model_idea
			add_idea = SHX_guominjun_model_idea_2
		}
	}
	else_if = {
		limit = { has_idea = SHX_guominjun_model_idea_2 }
		swap_ideas = {
			remove_idea = SHX_guominjun_model_idea_2
			add_idea = SHX_guominjun_model_idea_3
		}
	}
	else_if = {
		limit = { has_idea = SHX_guominjun_model_idea_3 }
		swap_ideas = {
			remove_idea = SHX_guominjun_model_idea_3
			add_idea = 	SHX_guominjun_model_idea_4
		}
	}
	else_if = {
		limit = { has_idea = SHX_guominjun_model_idea_4 }
		swap_ideas = {
			remove_idea = SHX_guominjun_model_idea_4
			add_idea = 	SHX_guominjun_model_idea_5
		}
	}
	else_if = {
		limit = { has_idea = SHX_guominjun_model_idea_5 } #Fallback
		every_unit_leader = {
			gain_xp = 200
		}
	}
	else = {
		custom_effect_tooltip = SHX_upgrade_guominjun_model_spirit_effect_tt
	}
	SHX_strengthen_feng_medium = yes
}
###- Balance of Power - ###

#NOTE：阎锡山为负值，冯玉祥为正值。

SHX_change_pop_effect = {#改变支持度
	set_temp_variable = { SHX_pop_change_var = SHX_bop_change_var }

	if = {
		limit = { 
			has_active_mission = SHX_looming_gmj_coup 
		}
		multiply_temp_variable = { SHX_pop_change_var = 0.25 } #1/4
	}
	else = {
		multiply_temp_variable = { SHX_pop_change_var = 0.10 } #Tenth it so post power struggle it’s not as easy to get 100%
	}

	set_temp_variable = { SHX_pop_change_neg_var = SHX_pop_change_var }

	multiply_temp_variable = { SHX_pop_change_neg_var = -1 } 

	add_popularity = {#冯玉祥
		ideology = authoritarian_democrat
		popularity = SHX_pop_change_var
	}
	add_popularity = {#阎锡山
		ideology = paternal_autocrat
		popularity = SHX_pop_change_neg_var
	}
}

SHX_change_timeout_effect = {#改变政变时间
	set_temp_variable = { SHX_timeout_change_var = SHX_bop_change_var }
	multiply_temp_variable = { SHX_timeout_change_var = 100 } #Turn it into a whole number
	multiply_temp_variable = { SHX_timeout_change_var = -4 } #Double it and invert it
	add_days_mission_timeout = {
		mission = SHX_looming_gmj_coup
		days = SHX_timeout_change_var
	}
}

#提升阎锡山的支持度
SHX_strengthen_yan_small = {
	set_temp_variable = { SHX_bop_change_var = -0.05 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.05
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_small_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +5 - overall decrease by -5 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}
SHX_strengthen_yan_medium = {
	set_temp_variable = { SHX_bop_change_var = -0.15 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.15
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_medium_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +15 - overall decrease by -15 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}
SHX_strengthen_yan_large = {
	set_temp_variable = { SHX_bop_change_var = -0.25 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = -0.25
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_yan_large_tooltip
	}
	log = "SHX_BOP_logging; Yan increase by +25 - overall decrease by -25 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

#激进度改变
SHX_revolution_all_time = {
	hidden_effect = {
		random_list = {
			30 = {
				add_to_variable = {
					var = SHX_revolution_line
					value = 1
				}
			}
			30 = {
				add_to_variable = {
					var = SHX_revolution_line
					value = 2
				}
			}
			30 = {
				add_to_variable = {
					var = SHX_revolution_line
					value = 3
				}
			}
		}
	}
	custom_effect_tooltip = SHX_revolution_all_time_tooltip
}

SHX_revolution_small = {
	add_to_variable = {
		var = SHX_revolution_line
		value = 3
	}
	custom_effect_tooltip = SHX_revolution_small_tooltip
}
SHX_revolution_medium = {
	add_to_variable = {
		var = SHX_revolution_line
		value = 10
	}
	custom_effect_tooltip = SHX_revolution_medium_tooltip
}
SHX_revolution_large = {
	add_to_variable = {
		var = SHX_revolution_line
		value = 15
	}
	custom_effect_tooltip = SHX_revolution_large_tooltip
}

SHX_decrease_revolution_small = {
	add_to_variable = {
		var = SHX_revolution_line
		value = -5
	}
	custom_effect_tooltip = SHX_decrease_revolution_small_tooltip
}
SHX_decrease_revolution_medium = {
	add_to_variable = {
		var = SHX_revolution_line
		value = -10
	}
	custom_effect_tooltip = SHX_decrease_revolution_medium_tooltip
}

#提升冯玉祥的支持度
SHX_strengthen_feng_small = {
	set_temp_variable = { SHX_bop_change_var = 0.05 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.05
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_small_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +5 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}
SHX_strengthen_feng_medium = {
	set_temp_variable = { SHX_bop_change_var = 0.15 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.15
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { NOT = { has_active_mission = SHX_looming_gmj_coup } }
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_medium_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +15 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}
SHX_strengthen_feng_large = {
	set_temp_variable = { SHX_bop_change_var = 0.25 }
	hidden_effect = {
		SHX_change_pop_effect = yes
		if = {
			limit = { has_active_mission = SHX_looming_gmj_coup }
			add_power_balance_value = {
				id = SHX_power_balance
				value = 0.25
			}
			SHX_change_timeout_effect = yes
		}
	}
	if = {
		limit = { 
			NOT = { has_active_mission = SHX_looming_gmj_coup } 
		}
		effect_tooltip = { SHX_change_pop_effect = yes }
	}
	else = {
		custom_effect_tooltip = SHX_strengthen_feng_large_tooltip
	}
	log = "SHX_BOP_logging; Feng increase by +25 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_power_balance|= 3];" #temp logging effects so BoP changes could be seen in game log
}

###- Victory Effects -###
SHX_yan_victory_effect = {#阎锡山大获全胜

	set_temp_variable = { yan_distance_from_victory_temp_variable = power_balance_value } #Ranges from 0 to 1
	#修改稳定度
	if = {
		limit = { SHX_yan_is_winning_trigger = yes }
		divide_temp_variable = { yan_distance_from_victory_temp_variable = 2 } #Ranges now from 0 to 0.5
	}
	else_if = {
		limit = { SHX_feng_is_winning_trigger = yes }
		divide_temp_variable = { yan_distance_from_victory_temp_variable = -2 } #Ranges now from 0 to -0.5
	}
	else = {
		set_temp_variable = { yan_distance_from_victory_temp_variable = -0.05 }
	}
	add_stability = yan_distance_from_victory_temp_variable

	remove_mission = SHX_looming_gmj_coup
	remove_mission = SHX_shao_zhuang_pai_zai_yun_dong
	remove_ideas = SHX_guominjun_unrest_idea
	remove_power_balance = { id = SHX_power_balance }

	country_event = { id = shx.powerstruggle.3 days = 1 }

	hidden_effect = {
		QIE = {
			country_event = { id = shx.zhifeng.1 days = 7 } #QIE is informed of outcome of Yan power struggle
		}
		log = "KR_Event_Logging;SHX Game Progression - Yan Xishan, Standard Path, Survived Independent;[GetDateText]"
	}
	mark_focus_tree_layout_dirty = yes
}
SHX_feng_victory_effect = {#冯玉祥大获全胜

	set_temp_variable = { feng_distance_from_victory_temp_variable = power_balance_value } #Ranges from 0 to 1
	#修改稳定度
	if = {
		limit = { SHX_yan_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = -2 } #Ranges now from 0 to -0.5
	}
	else_if = {
		limit = { SHX_feng_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = 2 } #Ranges now from 0 to 0.5
	}
	else = {
		set_temp_variable = { feng_distance_from_victory_temp_variable = -0.05 }
	}
	add_stability = feng_distance_from_victory_temp_variable

	remove_mission = SHX_looming_gmj_coup
	remove_mission = SHX_shao_zhuang_pai_zai_yun_dong
	remove_ideas = SHX_guominjun_unrest_idea
	remove_power_balance = { id = SHX_power_balance }

	country_event = { id = shx.powerstruggle.4 days = 1 } #The Shanxi Government Toppled!

	hidden_effect = {
		QIE = {
			country_event = { id = shx.zhifeng.2 days = 7 } #QIE is informed of outcome of Yan power struggle
		}
		log = "KR_Event_Logging;SHX Game Progression - Feng Yuxiang, Standard Path, Survived Independent;[GetDateText]"
	}
	mark_focus_tree_layout_dirty = yes 
}
SHX_shao_zhuang_victory_effect = {#少壮派胜出
	set_temp_variable = { feng_distance_from_victory_temp_variable = power_balance_value } #Ranges from 0 to 1
	#修改稳定度
	if = {
		limit = { SHX_yan_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = -2 } #Ranges now from 0 to -0.5
	}
	else_if = {
		limit = { SHX_feng_is_winning_trigger = yes }
		divide_temp_variable = { feng_distance_from_victory_temp_variable = 2 } #Ranges now from 0 to 0.5
	}
	else = {
		set_temp_variable = { feng_distance_from_victory_temp_variable = -0.05 }
	}
	add_stability = feng_distance_from_victory_temp_variable

	remove_mission = SHX_looming_gmj_coup
	remove_mission = SHX_shao_zhuang_pai_zai_yun_dong
	remove_ideas = SHX_guominjun_unrest_idea
	remove_power_balance = { id = SHX_power_balance }

	country_event = { id = shx.powerstruggle.13 days = 1 } #The Shanxi Government Toppled!

	mark_focus_tree_layout_dirty = yes
}

#冯玉祥军队滚蛋
SHX_feng_army_purged = {
	hidden_effect = {
		if = {
			limit = { 
				CHI = {
					exists = yes
				}
			}
			every_unit_leader = {
				limit = { 
					has_trait = SHX_gmj_officer 
					NOT = { 
						is_character = SHX_feng_yuxiang 
						is_character = SHX_yang_hucheng 
					}
				}
				demote_to_general = yes
				set_nationality = CHI
			}
			CHI = {
				country_event = {
					id = shx.powerstruggle.12
					days = 1
				}
			}
		}
		else_if = {
			limit = { 
				HNN = {
					exists = yes
					has_completed_focus = HNN_victory_of_the_united_front
				}
			}
			every_unit_leader = {
				limit = { 
					has_trait = SHX_gmj_officer 
					NOT = { 
						is_character = SHX_feng_yuxiang 
						is_character = SHX_yang_hucheng 
					}
				}
				demote_to_general = yes
				set_nationality = HNN
			}
			HNN = {
				country_event = {
					id = shx.powerstruggle.12
					days = 1
				}
			}
		}
		else_if = {
			limit = { 
				GXC = {
					GXC_has_KMT_government = yes
				}
			}
			every_unit_leader = {
				limit = { 
					has_trait = SHX_gmj_officer 
					NOT = { 
						is_character = SHX_feng_yuxiang 
						is_character = SHX_yang_hucheng 
					}
				}
				demote_to_general = yes
				set_nationality = GXC
			}
			GXC = {
				country_event = {
					id = shx.powerstruggle.12
					days = 1
				}
			}
		}	
	}
}
#阎锡山军队滚蛋
SHX_yan_army_purged = {
	hidden_effect = {
		608 = { #owner of Beijing
			owner = {
				if = {
					limit = { is_chinese_tag = yes }
					SHX = {
						SHX_zhao_chengshou = {
							demote_to_general = yes
							set_nationality = PREV.PREV
						}
						SHX_li_fuying = {
							demote_to_general = yes
							set_nationality = PREV.PREV
						}
						SHX_wang_jingguo = {
							demote_to_general = yes
							set_nationality = PREV.PREV
						}
						SHX_yang_aiyuan = {
							demote_to_general = yes
							set_nationality = PREV.PREV
						}
					}
					country_event = { id = shx.powerstruggle.10 days = 1 } #Exiles from Shanxi
				}
			}
		}
	}
	custom_effect_tooltip = characters_will_be_retired
	character_list_tooltip = {
		limit = {
			OR = {
				AND = {
					NOT = { is_character = SHX_shang_zhen }
					is_unit_leader = yes
					has_trait = SHX_yan_loyalist
				}
				is_character = SHX_zhu_shouguang
			}
		}
	}
	hidden_effect = {
		every_unit_leader = {
			limit = {
				has_trait = SHX_yan_loyalist
				NOT = { is_character = SHX_shang_zhen }
			}
			remove_unit_leader_role = yes
		}
	}
}
#冯玉祥、阎锡山军队一起滚蛋
SHX_shao_zhuang_army_purged = {
	#阎锡山
		hidden_effect = {
			608 = { #owner of Beijing
				owner = {
					if = {
						limit = { is_chinese_tag = yes }
						SHX = {
							SHX_zhao_chengshou = {
								demote_to_general = yes
								set_nationality = PREV.PREV
							}
							SHX_wang_jingguo = {
								demote_to_general = yes
								set_nationality = PREV.PREV
							}
							SHX_yang_aiyuan = {
								demote_to_general = yes
								set_nationality = PREV.PREV
							}
						}
						country_event = { id = shx.powerstruggle.10 days = 1 } #Exiles from Shanxi
					}
				}
			}
		}
		custom_effect_tooltip = characters_will_be_retired
		character_list_tooltip = {
			limit = {
				is_character = SHX_zhu_shouguang
			}
		}
		hidden_effect = {
			retire_character = SHX_zhu_shouguang
		}
	#冯玉祥
		hidden_effect = {
			if = {
				limit = { 
					CHI = {
						exists = yes
					}
				}
				every_unit_leader = {
					limit = { 
						has_trait = SHX_gmj_officer 
						NOT = { 
							is_character = SHX_feng_yuxiang 
							is_character = SHX_yang_hucheng 
							is_character = SHX_han_fuju
						}
					}
					demote_to_general = yes
					set_nationality = CHI
				}
				CHI = {
					country_event = {
						id = shx.powerstruggle.12
						days = 1
					}
				}
			}
			else_if = {
				limit = { 
					HNN = {
						exists = yes
						has_completed_focus = HNN_victory_of_the_united_front
					}
				}
				every_unit_leader = {
					limit = { 
						has_trait = SHX_gmj_officer 
						NOT = { 
							is_character = SHX_feng_yuxiang 
							is_character = SHX_yang_hucheng 
							is_character = SHX_han_fuju
						}
					}
					demote_to_general = yes
					set_nationality = HNN
				}
				HNN = {
					country_event = {
						id = shx.powerstruggle.12
						days = 1
					}
				}
			}
			else_if = {
				limit = { 
					GXC = {
						GXC_has_KMT_government = yes
					}
				}
				every_unit_leader = {
					limit = { 
						has_trait = SHX_gmj_officer 
						NOT = { 
							is_character = SHX_feng_yuxiang 
							is_character = SHX_yang_hucheng 
							is_character = SHX_han_fuju
						}
					}
					demote_to_general = yes
					set_nationality = GXC
				}
				GXC = {
					country_event = {
						id = shx.powerstruggle.12
						days = 1
					}
				}
			}	
		}
}

###- 北京 -###
SHX_convert_influence_to_war_support_effect = {#移除北京的影响力
	custom_effect_tooltip = SHX_convert_inf_to_ws_tooltip
	set_temp_variable = { SHX_War_Support = SHX_QIE_influence_variable }
	divide_temp_variable = { SHX_War_Support = 100 }
	divide_temp_variable = { SHX_War_Support = -2 }
	add_war_support = SHX_War_Support
	set_variable = { SHX_QIE_influence_variable = 0 }
	clr_country_flag = Shanxi_open_for_investment
}

SHX_set_up_QIE_influence_game = {#设定精神
	set_country_flag = SHX_paying_with_inf
	QIE = { 
		set_country_flag = QIE_influence_shanxi_available 
	}
	SHX_econ_update = yes
}

SHX_negotiate_econ_treaty = {
	if = {
		limit = { has_idea = SHX_qie_influence_idea4 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea4
			add_idea = SHX_qie_dominated_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea3 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea3
			add_idea = SHX_qie_prevelant_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea2 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea2
			add_idea = SHX_qie_equal_econ
		}
	}
	else_if = {
		limit = { has_idea = SHX_qie_influence_idea1 }
		swap_ideas = {
			remove_idea = SHX_qie_influence_idea1
			add_idea = SHX_qie_shx_dominated_econ
		}
	}
	else = { remove_ideas = SHX_qie_influence_idea0 }
}

###- 北京影响力等级 -###
SHX_econ_update = {
	hidden_effect = {
		SHX_remove_qie_econ = yes
		if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 90 } }
			add_ideas = SHX_qie_influence_idea4
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 60 } }
			add_ideas = SHX_qie_influence_idea3
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 30 } }
			add_ideas = SHX_qie_influence_idea2
		}
		else_if = {
			limit = { check_variable = { SHX.SHX_QIE_influence_variable > 10 } }
			add_ideas = SHX_qie_influence_idea1
		}
		else = { add_ideas = SHX_qie_influence_idea0 }
	}
}
SHX_remove_qie_econ = {
	if = {
		limit = { has_idea = SHX_qie_influence_idea0 }
		remove_ideas = SHX_qie_influence_idea0
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea1 }
		remove_ideas = SHX_qie_influence_idea1
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea2 }
		remove_ideas = SHX_qie_influence_idea2
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea3 }
		remove_ideas = SHX_qie_influence_idea3
	}
	if = {
		limit = { has_idea = SHX_qie_influence_idea4 }
		remove_ideas = SHX_qie_influence_idea4
	}
}
SHX_QIE_investment_change_inf_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_influence_variable
		value = SHX_QIE_inf_change_var
	}
	clamp_variable = {
		var = SHX.SHX_QIE_influence_variable
		min = 0
		max = 100
	}
	SHX_econ_update = yes
}

#增减北京影响力
SHX_QIE_investment_small = {
	if = {
		limit = { SHX_QIE_influence_active = yes } 
		set_temp_variable = { SHX_QIE_inf_change_var = 5 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_small_tooltip
		log = "SHX_influence_logging; investment increase by +5 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_investment_medium = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 10 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_medium_tooltip
		log = "SHX_influence_logging; investment increase by +10 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_investment_large = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 15 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_large_tooltip
		log = "SHX_influence_logging; investment increase by +15 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_investment_giga = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = 30 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_investment_giga_tooltip
		log = "SHX_influence_logging; investment increase by +30 [ROOT.GetTag];[GetDateText]; amount after increase: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

SHX_QIE_spend_small = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -5 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_small_tooltip
		log = "SHX_influence_logging; investment decrease by -5 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_spend_medium = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -10 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_medium_tooltip
		log = "SHX_influence_logging; investment decrease by -10 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_spend_large = {
	if = {
		limit = { SHX_QIE_influence_active = yes } 
		set_temp_variable = { SHX_QIE_inf_change_var = -15 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_large_tooltip
		log = "SHX_influence_logging; investment decrease by -15 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}
SHX_QIE_spend_giga = {
	if = {
		limit = { SHX_QIE_influence_active = yes } #make sure that influence is still relevent
		set_temp_variable = { SHX_QIE_inf_change_var = -30 }
		hidden_effect = {
			SHX_QIE_investment_change_inf_effect = yes
			SHX_marlib_change_pop_effect = yes
		}
		custom_effect_tooltip = SHX_QIE_spend_giga_tooltip
		log = "SHX_influence_logging; investment decrease by -30 [ROOT.GetTag];[GetDateText]; amount after decrease: [?SHX.SHX_QIE_influence_variable];" #temp logging effects so influence could be seen in game log
	}
}

#增加市自影响力
SHX_marlib_change_pop_effect = {
	set_temp_variable = { SHX_marlib_change_pop_var = SHX_QIE_inf_change_var }
	multiply_temp_variable = { SHX_marlib_change_pop_var = 0.01 } #Turn it into a decimal
	multiply_temp_variable = { SHX_marlib_change_pop_var = 0.33 } #Third it
	add_popularity = {
		ideology = market_liberal
		popularity = SHX_marlib_change_pop_var
	}
}

###- QIE Negotiations and Zhifeng -###
SHX_QIE_negotiation_demand_minus_1_effect = {
	subtract_from_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 1
		tooltip = SHX_QIE_negotiation_demand_minus_1_tooltip
	}
}
SHX_QIE_negotiation_demand_minus_2_effect = {
	subtract_from_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 2
		tooltip = SHX_QIE_negotiation_demand_minus_2_tooltip
	}
}


SHX_QIE_negotiation_demand_plus_1_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 1
		tooltip = SHX_QIE_negotiation_demand_plus_1_tooltip
	}
}
SHX_QIE_negotiation_demand_plus_2_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 2
		tooltip = SHX_QIE_negotiation_demand_plus_2_tooltip
	}
}
SHX_QIE_negotiation_demand_plus_3_effect = {
	add_to_variable = {
		var = SHX.SHX_QIE_negotiation_value
		value = 3
		tooltip = SHX_QIE_negotiation_demand_plus_3_tooltip
	}
}

SHX_QIE_negotiation_accept_effect = {

	set_global_flag = SHX_deal_QIE

	SHX = {
		set_country_flag = SHX_QIE_negotiations_succeed
		complete_national_focus = SHX_recognise_gov
		country_event = { id = shx.zhifeng.17 days = 1 } #Inform them of the SHX-QIE alliance
	}

	if = {
		limit = {
			check_variable = { #Activate Scenario 1 - SHX gets demilitarized East Shanxi
				SHX.SHX_QIE_negotiation_value = 1
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_1
			QIE = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				give_resource_rights = {
					receiver = QIE
					state = 615
				}
				if = {
					limit = {
						has_war = no
					}
					615 = {
						set_demilitarized_zone = yes
					}
				}
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 2 - SHX gets East Shanxi
				SHX.SHX_QIE_negotiation_value = 2
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_2
			QIE = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 3 - SHX gets Guanzhong (Xi'an)
				SHX.SHX_QIE_negotiation_value = 3
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_3
			QIE = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_guanzhong_effect = yes
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 4 - SHX gets East Shanxi and Guanzhong (Xi'an)
				SHX.SHX_QIE_negotiation_value = 4
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_4
			QIE = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				SHX_transfer_guanzhong_effect = yes
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
		}
	}

	else_if = {
		limit = {
			check_variable = { #Activate Scenario 5 - SHX gets East Shanxi and Guanzhong (Xi'an) + Claims on Suiyuan
				SHX.SHX_QIE_negotiation_value = 5
			}
		}
		hidden_effect = {
			set_global_flag = SHX_QIE_negotiation_scenario_5
			QIE = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
			}
			SHX = {
				country_event = shx.zhifeng.16 #Inform both parties of what just happened
				SHX_transfer_east_shanxi_effect = yes
				SHX_transfer_guanzhong_effect = yes
				add_state_claim = 616 #Ordos
				add_state_claim = 621 #Ulanqab
			}
		}
	}

	else = {
		hidden_effect = {
			QIE = {
				country_event = shx.zhifeng.16 #Inform there's been an error - Scenario 2 loaded
			}
			SHX = {
				SHX_transfer_east_shanxi_effect = yes
				country_event = shx.zhifeng.16 #Inform there's been an error - Scenario 2 loaded
			}
		}
	}

	custom_effect_tooltip = SHX_QIE_negotiation_accept_tooltip
	clear_variable = SHX.SHX_QIE_negotiation_value

}

SHX_transfer_east_shanxi_effect = {
	if = {
		limit = { 615 = { is_fully_controlled_by = QIE } }
		transfer_state = 615 #Eastern Shanxi
	}
	else = { set_state_owner = 615 } #Eastern Shanxi
}
SHX_transfer_guanzhong_effect = {
	if = {
		limit = { 799 = { is_fully_controlled_by = QIE } }
		transfer_state = 799 #Guanzhong (Xi'an)
	}
	else = { set_state_owner = 799 } #Guanzhong (Xi'an)
	add_state_core = 799 #Guanzhong (Xi'an)
}

###- Zhifeng War -###
SHX_attack_beijing_effect = { 
	var:608.owner = {
		SHX = {
			declare_war_on = {
				target = PREV
				type = annex_everything
			}
			if = {
				limit = {
					NOT = {
						has_active_mission = SHX_collapse_of_shanxi
					}
					any_neighbor_country = { controls_state = 608 }
				}
				effect_tooltip = { activate_mission = SHX_collapse_of_shanxi }
				custom_effect_tooltip = tooltip_white_line
			}
			if = {
				limit = { PREV = { tag = QIE } }
				QIE = { setup_decision_attack_AI = yes }
				SHX_convert_influence_to_war_support_effect = yes
				custom_effect_tooltip = tooltip_white_line
				add_ideas = SHX_war_of_liberation
			}
			else = {
				add_ideas = SHX_war_of_liberation
			}
		}
	}
}

SHX_add_flag_modifier = {
	if = {
		limit = { has_variable = SHX_states_available_for_setting_plans }
		for_loop_effect = {
			start = SHX_states_available_for_setting_plans
			end = 4
			random_scope_in_array = {
				array = SHX_zhifeng_targets_array
				limit = {
					has_state_flag = SHX_war_plan_flagged_state
					NOT = { has_dynamic_modifier = { modifier = SHX_war_plan_modifier } }
					THIS.owner = { has_war_with = SHX }
				}
				add_dynamic_modifier = { modifier = SHX_war_plan_modifier }
				if = {
					limit = {
						SHX = { has_completed_focus = SHX_cloak_dagger }
						has_resistance = no
					}
					force_enable_resistance = { occupier = QIE }
					start_resistance = yes
				}
			}
		}
	}
}

SHX_remove_flag_modifier = { #for use once war is over to clear out all of the planning effects, flags, array and Vars
	if = {
		limit = { has_variable = SHX_states_available_for_setting_plans }
		for_loop_effect = {
			start = SHX_states_available_for_setting_plans
			end = 4
			random_scope_in_array = {
				array = SHX_zhifeng_targets_array
				limit = {
					has_state_flag = SHX_war_plan_flagged_state
				}
				remove_dynamic_modifier = { modifier = SHX_war_plan_modifier }
				force_enable_resistance = { occupier = QIE clear = yes }
			}
		}
		clear_array = SHX_zhifeng_targets_array
		clear_variable = SHX_states_available_for_setting_plans
		clear_variable = SHX_war_plan_supplies_modifier
		clear_variable = SHX_war_plan_org_rate_modifier
		clear_variable = SHX_war_plan_speed_modifier
		clear_variable = SHX_war_plan_resistance_target
	}
}

SHX_convert_flag_modifier = { #for use when SHX captured a state they flagged - replaces modifier with bonuses if any
	if = {
		limit = { has_dynamic_modifier = { modifier = SHX_war_plan_modifier } }
		SHX = {
			if = {
				limit = { has_completed_focus = SHX_shen_tou_zhan_shu } #spawn divisions
				if = {
					limit = {
						NOT = { has_template = "Sacrifice League" } ##placeholder name based on 牺牲救国同盟会
					}
					division_template = {
						name = "Sacrifice League"
						division_names_group = CHYN_MIL_01
						regiments = {
							irregular_infantry = { x = 0 y = 0 }
							irregular_infantry = { x = 0 y = 1 }
							irregular_infantry = { x = 1 y = 0 }
							irregular_infantry = { x = 1 y = 1 }
						}
						priority = 0
					}
				}
				PREV = {
					create_unit = {
						division = "division_template = \"Sacrifice League\" start_experience_factor = 0.05 start_equipment_factor = 0.75"
						owner = SHX
						allow_spawning_on_enemy_provs = no
						count = 1
					}
				}
			}
			if = {
				limit = { has_completed_focus = SHX_dao_de_zhi_shi } #give compliance
				PREV = {
					add_compliance = 30
				}
			}
		}
		remove_dynamic_modifier = { modifier = SHX_war_plan_modifier }
		force_enable_resistance = { occupier = QIE clear = yes }
		clr_state_flag = SHX_war_plan_flagged_state
	}
}

SHX_set_NCPC_cosmetic_effect = {
	if = {
		limit = { has_cosmetic_tag = SHX_KMT }
		set_cosmetic_tag = SHX_NCPC_KMT
	}
	else = {
		set_cosmetic_tag = SHX_NCPC
	}
}

SHX_vanguard_wargoals_effect = {
	if = {
		limit = {
			SHX_no_cosmetic_flag_check = yes
		}
		SHX_set_NCPC_cosmetic_effect = yes
	}
	MON = { SHX_vanguard_claim_effect = yes }
	TIB = { SHX_vanguard_claim_effect = yes }
	SIK = { SHX_vanguard_claim_effect = yes }
	ETS = { SHX_vanguard_claim_effect = yes }
	XSM = { SHX_vanguard_claim_effect = yes }
}

SHX_vanguard_claim_effect = {
	#Scope should be tag
	if = {
		limit = { THIS = { NOT = { is_ally_with = QIE } } }
		THIS = {
			every_core_state = { add_claim_by = SHX }
			SHX = { activate_targeted_decision = { target = PREV decision = china_attack_decision } }
		}
	}
}

SHX_add_join_government_decisions = {
	if = { # Feng only ones
		limit = { has_country_leader = { character = SHX_feng_yuxiang } }
		if = { #LKMT
			limit = { CHI = { china_is_valid_government_to_join = yes } }
			activate_targeted_decision = { target = CHI decision = SHX_join_government }
		}
		if = { #Feds
			limit = { country_exists = UPC }# needed a check if NPA exists so it wont give errors on scoping to it
			if = {
				limit = { UPC = { china_is_valid_government_to_join = yes } }
				activate_targeted_decision = { target = UPC decision = SHX_join_government }
			}
		}
	}
	else = { # Yan only ones
		if = { # Fengtian
			limit = { FNG = { china_is_valid_government_to_join = yes } }
			activate_targeted_decision = { target = FNG decision = SHX_join_government }
		}
		if = { # Zhili Remnants
			limit = {
				SZC = { china_is_valid_government_to_join = yes }
				SZC = { SZC_zhili_in_exile = yes }
			}
			activate_targeted_decision = { target = SZC decision = SHX_join_government }
		}
	}
	else_if = { # check for GXC RKMT second
		limit = {
			GXC = {
				china_is_valid_government_to_join = yes
				is_ruled_by_right_kmt = yes
			}
		}
		activate_targeted_decision = { target = GXC decision = SHX_join_government }
	}
	if = { # NPA
		limit = { 
			country_exists = NPA 
			NPA = { china_is_valid_government_to_join = yes }
		}#needed a check if NPA exists so it wont give errors on scoping to it
		activate_targeted_decision = { target = NPA decision = SHX_join_government }
	}
}

SHX_seize_suiyuan_effect = {
	if = {
		limit = { ROOT = { owns_state = 616 } } #Ordos
		616 = { transfer_state_to = SHX }
	}
	if = {
		limit = { ROOT = { owns_state = 621 } } #Ulanqab
		621 = { transfer_state_to = SHX }
	}
	if = {
		limit = {
			owns_state = 612 #Northern Chahar
			330 = { owner = { NOT = { tag = ROOT } } } #If Mongolia isn't also owned by (directly or indirectly) whoever Suiyuan is being stolen from, will steal Northern Chahar as well)
		}
		612 = { transfer_state_to = SHX }
		custom_effect_tooltip = SHX_suiyuan_warn_loss_of_chahar_to_SHX_tooltip
	}
	else_if = { #Basically if XSM vassalized Mongolia and loses Suiyuan, Northern Chahar goes to Mongolia to avoid border gore
		limit = {
			owns_state = 612 #Northern Chahar
			MON = { is_subject_of = ROOT }
		}
		330 = { transfer_state_to = MON }
		custom_effect_tooltip = SHX_suiyuan_warn_loss_of_chahar_to_MON_tooltip
	}
	add_opinion_modifier = {
		target = SHX
		modifier = KR_outraged
	}
	reverse_add_opinion_modifier = {
		target = SHX
		modifier = KR_returned_land
	}
}

SHX_start_suiyuan_crisis = {
	if = {
		limit = { has_country_flag = SHX_QIE_declared_neutrality_in_suiyuan_campaign_flag }
		QIE = {
			add_ideas = SHX_suiyuan_QIE_neutrality_idea #Keep QIE from participating in Northwest affairs for the duration of the spirit
			activate_targeted_decision = { 
				target = QIE 
				decision = SHX_QIE_end_northwestern_neutrality_decision 
			}
			set_country_flag = { flag = SHX_suiyuan_QIE_neutrality_flag days = 365 value = 1 } # Value needs to be there or the effect won't work
		}
	}
	activate_mission = SHX_march_on_suiyuan_mission
	activate_mission_tooltip = SHX_march_on_suiyuan_mission
	#activate all related decisions
	if = {
		limit = { var:616.owner = { NOT = { tag = SHX } } }
		activate_targeted_decision = { 
			target = var:616.owner 
			decision = SHX_suiyuan_begin_northwestern_expedition 
		}
		activate_targeted_decision = { 
			target = var:616.owner 
			decision = SHX_suiyuan_send_scouts_to_enemy 
		}
		activate_targeted_decision = { 
			target = SHX 
			decision = SHX_suiyuan_gather_supplies 
		}
		activate_targeted_decision = { 
			target = SHX 
			decision = SHX_suiyuan_decisive_first_strike_decision 
		}
	}
	if = {
		limit = { var:616.owner = { is_chinese_tag = no } }
		activate_targeted_decision = { 
			target = var:616.owner 
			decision = SHX_prepare_hui_provisional_leaders 
		}
	}
	#activate decisions on enemy side
	var:616.owner = {#Ordos
		country_event = shx.suiyuan.campaign.31 #Shanxi mobilises for Suiyuan!
		activate_mission = SHX_march_on_suiyuan_mission
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
		activate_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
		activate_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
		activate_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
		if = {
			limit = {
				is_guaranteed_by = TIB
			}
			TIB = {
				country_event = shx.suiyuan.campaign.31
				activate_mission = SHX_march_on_suiyuan_mission
				activate_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
				activate_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
				activate_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
				activate_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
			}
		}
		if = { #allow Shanxi's enemy to destablized them in Gansu if they own it
			limit = { SHX = { owns_state = 283 } } #Lanzhou
			activate_targeted_decision = { target = 283 decision = SHX_suiyuan_destabilise_province }
		}
	}
	country_event = shx.suiyuan.campaign.36
	616 = { save_global_event_target_as = SHX_targeted_state }
}

#effect to remove all of the pre war decisions - fired if they either go to war, or if crisis defuses through other means
SHX_end_suiyuan_crisis = {
	hidden_effect = {
		if = {
			limit = { tag = SHX }
			remove_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_begin_northwestern_expedition }
			remove_targeted_decision = { target = var:616.owner decision = SHX_suiyuan_send_scouts_to_enemy }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_gather_supplies }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_decisive_first_strike_decision }
			remove_targeted_decision = { target = var:616.owner decision = SHX_prepare_hui_provisional_leaders }
		}
		else = {
			remove_mission = SHX_march_on_suiyuan_mission
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_send_scouts_to_enemy }
			remove_targeted_decision = { target = SHX decision = SHX_suiyuan_raid_SHX_supply_bases_decision }
			remove_targeted_decision = { target = THIS decision = SHX_suiyuan_fortify_frontier_decision }
			remove_targeted_decision = { target = THIS decision = SHX_suiyuan_rally_local_supporters_decision }
		}
	}
}

SHX_suiyuan_campaign_prep_add_small = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 30
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_small_tooltip
}
SHX_suiyuan_campaign_prep_add_medium = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 50
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_medium_tooltip
}
SHX_suiyuan_campaign_prep_add_large = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = 100
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_add_large_tooltip
}

SHX_suiyuan_campaign_prep_subtract_small = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -30
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_small_tooltip
}
SHX_suiyuan_campaign_prep_subtract_medium = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -50
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_medium_tooltip
}
SHX_suiyuan_campaign_prep_subtract_large = {
	add_to_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		value = -100
	}
	clamp_variable = {
		var = SHX.SHX_suiyuan_campaign_prep_variable
		min = 0
		max = 500
	}
	custom_effect_tooltip = SHX_suiyuan_campaign_prep_subtract_large_tooltip
}

SHX_suiyuan_campaign_tally_success_effect = {
	set_variable = {
		var = SHX_suiyuan_claimed_states_unfulfilment_variable
		value = SHX_suiyuan_claimed_states_variable
	}
	if = {
		limit = { owns_state = 616 } #Ordos
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 621 } #Ulanqab
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 348 } #Ningxia
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 604 } #Xining
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
	if = {
		limit = { owns_state = 353 } #Yushu
		subtract_from_variable = { SHX_suiyuan_claimed_states_unfulfilment_variable = 1 }
	}
}

#########################
###- Endgame Effects -###
#########################

SHX_lategame_transition_effect = {
	hidden_effect = {
		set_country_flag = SHX_lategame_begin_flag
		mark_focus_tree_layout_dirty = yes

		#Political Spirits
		SHX_lategame_remove_political_spirits_effect = yes
		#Military Spirits
		SHX_lategame_remove_military_spirits_effect = yes
		#Education Spirits
		SHX_lategame_remove_education_spirits_effect = yes
		#Mining Spirits
		SHX_lategame_remove_mining_spirits_effect = yes
		#Industrial Spirits
		SHX_lategame_transform_industry_spirits_effect = yes
		#Agricultural Spirits
		SHX_lategame_transform_agriculture_spirits_effect = yes

		if = { #Failsafe
			limit = { has_active_mission = SHX_industrial_reform_mission_timer }
			remove_mission = SHX_industrial_reform_mission_timer
		}
		if = { #Failsafe
			limit = { has_active_mission = SHX_agricultural_reform_mission_timer }
			remove_mission = SHX_agricultural_reform_mission_timer
		}
		if = { #Failsafe
			limit = { has_active_mission = SHX_educational_reform_mission_timer }
			remove_mission = SHX_educational_reform_mission_timer
		}
	}
	# CHN_setup_lategame_debuffs_effect = yes
	custom_effect_tooltip = SHX_lategame_effect_tooltip
}

SHX_lategame_remove_political_spirits_effect = {
	if = {
		limit = { has_idea = SHX_neutrality }
		remove_ideas = SHX_neutrality
	}
	if = {
		limit = { has_idea = SHX_strict_neutrality1 }
		remove_ideas = SHX_strict_neutrality1
	}
	if = {
		limit = { has_idea = SHX_a_higher_purpose_idea }
		remove_ideas = SHX_a_higher_purpose_idea
	}
	if = {
		limit = { has_idea = SHX_stable_future_idea }
		remove_ideas = SHX_stable_future_idea
	}
	if = {
		limit = { has_idea = SHX_towards_revolution_idea }
		remove_ideas = SHX_towards_revolution_idea
	}
}

SHX_lategame_remove_military_spirits_effect = {
	if = {
		limit = { has_idea = SHX_war_of_liberation }
		remove_ideas = SHX_war_of_liberation
	}
	if = {
		limit = { has_idea = SHX_fortress_shanxi }
		remove_ideas = SHX_fortress_shanxi
	}
	if = {
		limit = { has_idea = SHX_labouring_army_idea }
		remove_ideas = SHX_labouring_army_idea
	}
}

SHX_lategame_remove_education_spirits_effect = {
	if = {
		limit = { has_idea = SHX_unfinished_education }
		remove_ideas = SHX_unfinished_education
	}
	if = {
		limit = { has_idea = SHX_unfinished_education1 }
		remove_ideas = SHX_unfinished_education1
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_yan }
		remove_ideas = SHX_unfinished_education_yan
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_yan1 }
		remove_ideas = SHX_unfinished_education_yan1
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_feng }
		remove_ideas = SHX_unfinished_education_feng
	}
	if = {
		limit = { has_idea = SHX_unfinished_education_feng1 }
		remove_ideas = SHX_unfinished_education_feng1
	}
}

SHX_lategame_remove_mining_spirits_effect = {
	if = {
		limit = { has_idea = SHX_private_coal }
		remove_ideas = SHX_private_coal
	}
	if = {
		limit = { has_idea = SHX_regulate_coal }
		remove_ideas = SHX_regulate_coal
	}
	if = {
		limit = { has_idea = SHX_inefficient_coal }
		remove_ideas = SHX_inefficient_coal
	}
}

SHX_lategame_transform_industry_spirits_effect = {
	if = {
		limit = { has_idea = SHX_Ten_Year_Plan_begins }
		remove_ideas = 	SHX_Ten_Year_Plan_begins
	}
	if = {
		limit = { has_idea = SHX_Ten_Year_Plan_disrupted }
		remove_ideas = 	SHX_Ten_Year_Plan_disrupted
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy }
		remove_ideas = SHX_underdeveloped_mountain_economy
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy1 }
		remove_ideas = SHX_underdeveloped_mountain_economy1
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy2 }
		remove_ideas = SHX_underdeveloped_mountain_economy2
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng
	}

	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng1 }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng1
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_1_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_1_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_feng2 }
		remove_ideas = SHX_underdeveloped_mountain_economy_feng2
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_2_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_2_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_yan1 }
		remove_ideas = SHX_underdeveloped_mountain_economy_yan1
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_3_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_3_agriculture_3_modifier }
			}
		}
	}
	if = {
		limit = { has_idea = SHX_underdeveloped_mountain_economy_yan2 }
		remove_ideas = SHX_underdeveloped_mountain_economy_yan2
		if = {
			limit = { has_idea = SHX_agriculture_reform_Feng1 }
			remove_ideas = SHX_agriculture_reform_Feng1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_4_agriculture_1_modifier }
			}
		}
		else_if = {
			limit = { has_idea = SHX_agriculture_reform_Yan1 }
			remove_ideas = SHX_agriculture_reform_Yan1
			every_owned_state = {
				limit = {
					OR = {
						state = 622 #Yulin
						state = 1072 #Western Shanxi
						state = 615 #Eastern Shanxi
						state = 799 #Guanzhong
					}
				}
				add_dynamic_modifier = { modifier = SHX_province_economy_4_agriculture_3_modifier }
			}
		}
	}
}

SHX_lategame_transform_agriculture_spirits_effect = {
	if = {
		limit = { has_idea = SHX_agriculture_reform }
		remove_ideas = SHX_agriculture_reform
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform1 }
		remove_ideas = SHX_agriculture_reform1
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform_Yan }
		remove_ideas = SHX_agriculture_reform_Yan
	}
	if = {
		limit = { has_idea = SHX_agriculture_reform_Feng }
		remove_ideas = SHX_agriculture_reform_Feng
	}
}

#########################
####- Manchu Coup - #####
#########################
SHX_manchu_coup_setup_effect = {
	SHX_manchu_set_up_starting_positions_effect = yes
	SHX_manchu_gmj_leadership_activation = yes
	SHX_convert_influence_to_war_support_effect = yes
	SHX_remove_qie_econ = yes
	complete_national_focus = SHX_destiny
	add_command_power = 100
	declare_war_on = {
		target = QIE
		type = take_claimed_state
		generator = { 615 }
	}
	SHX_manchu_set_up_timer_effect = yes
	hidden_effect = { news_event = SHX.manchu.11 } #The Central Plains War
}

SHX_manchu_set_up_starting_positions_effect = {
	hidden_effect = {
		QIE = {
			remove_opinion_modifier = {
				target = SHX
				modifier = KR_friendly
			}
			set_province_controller = 1962
			if = {
				limit = { NOT = { has_template = "Fangong Baoweituan" } }
				division_template = {
					name = "Fangong Baoweituan" #PLACEHOLDER - historically it was the Anti-Communist Militia - might want to look up "Anti-Socialist"
					division_names_group = CHYN_MIL_01
					regiments = {
						militia = { x = 0 y = 0 }
						militia = { x = 0 y = 1 }
						militia = { x = 0 y = 2 }
						militia = { x = 1 y = 0 }
						militia = { x = 1 y = 1 }
						militia = { x = 1 y = 2 }
					}
				}
			}
			615 = {
				#Eastern Shanxi
				teleport_armies = {
					limit = { tag = QIE }
					to_state = 1062 #Every QIE division in Eastern Shanxi goes to Baoding
				}
			}
			1072 = {
				#Western Shanxi
				teleport_armies = {
					limit = { tag = SHX }
					to_state = 1072 #Every SHX division in Taiyuan goes to the rest of Western Shanxi
				}
				create_unit = {
					division = "name = \"Taiyuan Anti-Socialist Militia\" division_template = \"Fangong Baoweituan\" start_experience_factor = 0.60"
					owner = QIE
				}
				if = {
					limit = { SHX = { has_country_flag = SHX_took_payout_flag } } #Lol I bet you thought this decision was inconsequential
					create_unit = {
						division = "name = \"Taiyuan Merchants' Militia\" division_template = \"Fangong Baoweituan\" start_experience_factor = 0.60"
						owner = QIE
					}
				}
			}
		}

		SHX = {
			add_timed_idea = {
				idea = SHX_central_plains_war_idea
				days = 30
			}
			remove_opinion_modifier = {
				target = QIE
				modifier = KR_friendly
			}

			#Get a mountaineer related bonus
			if = {
				limit = { NOT = { has_completed_focus = SHX_mountains_our_home } }
				complete_national_focus = SHX_mountains_our_home
			}
			else = {
				if = {
					limit = { NOT = { has_template = "GMJ Shandi Shi" } }
					division_template = {
						name = "GMJ Shandi Shi"
						division_names_group = CHYN_INF_01
						regiments = {
							mountaineers = { x = 0 y = 0 }
							mountaineers = { x = 0 y = 1 }
							mountaineers = { x = 1 y = 0 }
							mountaineers = { x = 1 y = 1 }
						}
						support = {
							recon = { x = 0 y = 0 }
						}
					}
				}
				1072 = {
					create_unit = {
						division = "name = \"Guominjun Reservists\" division_template = \"GMJ Shandi Shi\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 1115
					}
				}
			}

			#Add the spawned militias
			if = {
				limit = { NOT = { has_template = "Guomindang Minbing" } }
				division_template = {
					name = "Guomindang Minbing" #KMT Militia
					division_names_group = CHYN_MIL_01
					regiments = {
						militia = { x = 0 y = 0 }
						militia = { x = 0 y = 1 }
						militia = { x = 0 y = 2 }
						militia = { x = 1 y = 0 }
						militia = { x = 1 y = 1 }
						militia = { x = 1 y = 2 }
					}
				}
			}
			1072 = {
				create_unit = {
					division = "name = \"Shang Clique Defectors\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
					owner = SHX
					prioritize_location = 1115
				}
				if = {
					limit = { SHX = { NOT = { has_country_flag = SHX_took_payout_flag } } } #Lol and you thought stoking resistance was worthless
					create_unit = {
						division = "name = \"Taiyuan Republican Rebels\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 1115
					}
				}
				add_resistance = 80 #Get it high to balance out QIE
			}
			if = {
				limit = { SHX = { NOT = { has_country_flag = SHX_took_payout_flag } } } #Lol and you thought stoking resistance was worthless
				set_province_controller = 12432
				615 = {
					#Eastern Shanxi
					create_unit = {
						division = "name = \"Datong Miners' Uprising\" division_template = \"Guomindang Minbing\" start_experience_factor = 0.60"
						owner = SHX
						prioritize_location = 12432
					}
				}
			}

			#Adjust advisor stuff now that they belong to QIE
			SHX_yan_xishan = {
				set_nationality = QIE
			}
			create_country_leader = {
				name = "贾景德"
				picture = "gfx/leaders/SQI/Portrait_Shandong_Zhang_Tianran.png"
				expire = "1.1.1"
				ideology = paternal_autocrat_subtype
			}
			set_party_name = { #Rename Feng's Party from GMJ to National Party
				ideology = paternal_autocrat
				long_name = SHX_jia_jingde_remnant_party_long
				name = SHX_jia_jingde_remnant_party
			}
		}
	}
	if = {
		limit = { tag = SHX }
		set_capital = { 
			state = 622 
			remember_old_capital = no 
		} #Keeps the capital in Yulin, post-war event will allow you to decide whether or not to move the capital.
		country_event = { id = SHX.manchu.7 days = 2 } #An Emergency Capital.
		swap_ideas = {
			remove_idea = SHX_dual_armies
			add_idea = SHX_integrated_army
		}
		unlock_national_focus = SHX_he_bian_liang_jun
	}
}

SHX_manchu_gmj_leadership_activation = {
	hidden_effect = {
		SHX_lu_zhonglin = {
			hidden_effect = { #temp fix for CTD
				set_nationality = ROOT
			}
			add_advisor_role = {
				advisor = {
					slot = army_chief
					idea_token = SHX_lu_zhonglin_army_chief
					desc = SHX_lu_zhonglin_desc
					traits = { KR_army_chief_reform_2 }
					cost = 100
				}
			}
		}
	}
}

SHX_manchu_set_up_timer_effect = {
	QIE = {
		activate_mission = QIE_eyes_on_the_border #Redundant - do not get rid of it because QIE might fail the mission earlier
		activate_mission = QIE_SHX_intervention
		custom_effect_tooltip = QIE_SHX_intervention_tooltip
	}
	SHX = {
		activate_mission = QIE_SHX_intervention_visual_only
	}
}

SHX_manchu_peace_effect = {
	#Check to see progress in the northern front
	if = {
		limit = { 
			QIE = { 
				controls_state = 1015 
			} 
		} 
		1015 = { SHX_manchu_state_transfer_effect = yes }
	}
	if = {
		limit = { 
			QIE = { 
				controls_state = 1072 
			} 
		} #Western Shanxi - starts off in SHX ownership
		1072 = { SHX_manchu_state_transfer_effect = yes }
	}
	else_if = {
		limit = { SHX = { controls_state = 615 } } #Eastern Shanxi - Starts off in QIE ownership
		615 = {
			SHX_manchu_state_transfer_effect = yes
			if = {
				limit = { has_dynamic_modifier = { modifier = SHX_eastern_shanxi_strikes_modifier } }
				remove_dynamic_modifier = { modifier = SHX_eastern_shanxi_strikes_modifier }
			}
		}
	}
	#Check to See Progress in the Southern Front
	if = {
		limit = { QIE = { controls_state = 799 } } #Guanzhong (Xi'an) - Starts off in SHX ownership
		799 = { SHX_manchu_state_transfer_effect = yes }
		QIE = {
			if = {
				limit = {
					controls_state = 622 #Yulin - Starts off in SHX control. This is a failsafe
					controls_state = 1015
					controls_state = 1072 #If QIE owns Yulin and GMJ failed to retake Taiyuan, game over for SHX
				}
				annex_country = { target = SHX }
			}
		}
	}
	else_if = {
		limit = {
			SHX = {
				controls_state = 607 #Helou - starts off in QIE ownership.
				controls_state = 1015
				controls_state = 1072 #West Shanxi - starts off SHX ownership
			}
		}
		607 = {
			SHX_manchu_state_transfer_effect = yes
			add_core_of = SHX
		}
	}
	QIE = {
		white_peace = SHX
		set_truce = {
			target = SHX
			days = 180
		}
		diplomatic_relation = {
			country = SHX
			relation = non_aggression_pact
		}
		reverse_add_opinion_modifier = {
			target = SHX
			modifier = KR_hostile
		}
		add_opinion_modifier = {
			target = SHX
			modifier = KR_hostile
		}
	}
}

SHX_manchu_state_transfer_effect = {
	#Initial Scope should be a state
	if = {
		limit = { is_owned_by = QIE }
		transfer_state_to = SHX
	}
	else_if = {
		limit = { is_owned_by = SHX }
		transfer_state_to = QIE
	}
}