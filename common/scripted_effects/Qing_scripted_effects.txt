QIE_recalculate_peking_commission = {
	set_variable = { var_PEKCOM_influence = QIE.party_popularity@market_liberal }
	set_variable = { var_PEKCOM_influence_positive = QIE.party_popularity@market_liberal }
	multiply_variable = { var_PEKCOM_influence = -0.5 }
	multiply_variable = { var_PEKCOM_influence_positive = 0.5 }
}

QIE_recalculate_yiguandao_influence = {
	set_variable = { var_YIG_influence = QIE.party_popularity@national_populist }
	multiply_variable = { var_YIG_influence = -1 }
	clamp_variable = {
		var = var_YIG_influence
		min = -0.5
		max = 0
	}
}

QIE_add_yiguandao_modifier = {
	add_dynamic_modifier = {
		modifier = QIE_yiguandao_influence_dynamic_modifier
		scope = QIE
	}
}

QIE_remove_peking_commission = {
	clr_country_flag = germany_support
	clear_variable = var_PEKCOM_influence
	remove_dynamic_modifier = { modifier = QIE_german_influence_dynamic_modifier }
}

QIE_zhili_clique_flees = {
	### if SZC is Authdem, move all Zhili generals into hiding
	### 他们将逃亡四川
	if = {
		limit = {
			SZC = { has_government = authoritarian_democrat }
		}
		every_unit_leader = {
			limit = {
				OR = {
					is_character = QIE_jiang_bai_li
					is_character = QIE_wang_huaiqing
					is_character = QIE_zhang_qihuang
					is_character = QIE_xiao_yaonan
					is_character = QIE_zhang_shaozeng
					is_character = QIE_liu_menggeng
					is_character = QIE_cai_chengxun
					is_character = QIE_Cao_Shijie
				}
			}
			set_nationality = NSW
		}
		### then trigger the Zhili Remnant switch
		SZC = {
			country_event = { id = sichuan.264 days = 20 random_hours = 480 }
		}
	}
	### if SZC is not AuthDem, scatter the generals
	else = {
		### Jiang Baili flees to Guangdong, Zhang Qihuang to Guangxi
		if = {
			limit = {
				NOT = {
					GXC = { has_country_flag = GXC_had_civil_war }
				}
			}
			random_unit_leader = {
				limit = { #Jiang Baili 
					is_character = QIE_jiang_bai_li
				} 
				add_unit_leader_trait = GXC_guangdong_clique_officer
				set_nationality = GXC
				unit_leader_event = qieflavor.14
			}
			random_unit_leader = {
				limit = { is_character = QIE_zhang_qihuang }
				add_unit_leader_trait = GXC_guangxi_clique_officer
				set_nationality = GXC
				unit_leader_event = qieflavor.14
			}
		}
		else = {
			random_other_country = {
				limit = {
					OR = {
						tag = GXC
						tag = PRC
					}
					GXC_has_guangdong_government = yes
					GXC_has_KMT_government = no
				}
				ROOT = {
					random_unit_leader = {
						limit = { #Jiang Baili
							is_character = QIE_jiang_bai_li
						} 
						add_unit_leader_trait = GXC_guangdong_clique_officer
						set_nationality = PREV.PREV
						unit_leader_event = qieflavor.14
					}
				}
			}
			random_other_country = {
				limit = {
					OR = {
						tag = GXC
						tag = PRC
					}
					GXC_has_guangxi_government = yes
					GXC_has_KMT_government = no
				}
				ROOT = {
					random_unit_leader = {
						limit = { is_character = QIE_zhang_qihuang }
						add_unit_leader_trait = GXC_guangxi_clique_officer
						set_nationality = PREV.PREV
						unit_leader_event = qieflavor.14
					}
				}
			}
			### if the target is invalid, goes into hiding instead
			if = {
				limit = { has_character = QIE_jiang_bai_li } #Jiang Baili
				random_unit_leader = {
					limit = { #Jiang Baili
						is_character = QIE_jiang_bai_li
					} 
					set_nationality = NSW
				}
			}
			if = {
				limit = { has_character = QIE_zhang_qihuang } #Zhang Qihuang
				random_unit_leader = {
					limit = { is_character = QIE_zhang_qihuang }
					set_nationality = NSW
				}
			}
		}
		### Xiao Yaonan flees to non-KMT Sichuan or goes into hiding
		if = {
			limit = {
				SZC = { SZC_has_officer_government = no }
			}
			random_unit_leader = {
				limit = { is_character = QIE_xiao_yaonan } #Xiao Yaonan
				set_nationality = SZC
				unit_leader_event = qieflavor.14
			}
		}
		else = {
			random_unit_leader = {
				limit = { is_character = QIE_xiao_yaonan } #Xiao Yaonan
				set_nationality = NSW
			}
		}
		### SZC's generals flee to LEP or go into hiding
		if = {
			limit = { country_exists = LEP }
			every_unit_leader = {
				limit = {
					OR = {
						has_id = 1129 #Yang Sen
						has_id = 1130 #Liu Cunhou
						has_id = 1131 #Fan Shaozeng
						has_id = 1133 #He Guoguang
					}
				}
				set_nationality = LEP
				if = {
					limit = { has_id = 1129 } #Yang Sen
					unit_leader_event = qieflavor.14
				}
			}
		}
		else = {
			every_unit_leader = {
				limit = {
					OR = {
						has_id = 1129 #Yang Sen
						has_id = 1130 #Liu Cunhou
						has_id = 1131 #Fan Shaozeng
						has_id = 1133 #He Guoguang
					}
				}
				set_nationality = NSW
			}
		}
		### Wang Huaiqing and Zhang Shaozeng flee to non-backer SHX or go into hiding
		if = {
			limit = {
				NOT = { has_country_flag = QIE_yan_backs_coup }
			}
			every_unit_leader = {
				limit = {
					OR = {
						is_character = QIE_wang_huaiqing
						is_character = QIE_zhang_shaozeng
					}
				}
				set_nationality = SHX
				unit_leader_event = qieflavor.14
			}
		}
		else = {
			every_unit_leader = {
				limit = {
					OR = {
						is_character = QIE_wang_huaiqing
						is_character = QIE_zhang_shaozeng
					}
				}
				set_nationality = NSW
			}
		}
		### Cai Chengxun and Liu Menggeng flee to FNG
		every_unit_leader = {
			limit = {
				OR = {
					is_character = QIE_cai_chengxun
					is_character = QIE_liu_menggeng
				}
			}
			set_nationality = FNG
			unit_leader_event = qieflavor.14
		}
		### Cai Shijie flees to HNN
		QIE_Cao_Shijie = {
			limit = { is_character = QIE_Cao_Shijie } #Cai Shijie
			set_nationality = HNN
			unit_leader_event = qieflavor.14
		}
	}
}

QIE_kill_manchus = {
	effect_tooltip = {
		every_unit_leader = {
			limit = {
				OR = {
					is_character = QIE_aisin_gioro_zaitao
					is_character = QIE_aisin_gioro_pujie
					is_character = QIE_aisin_gioro_xiqia
				}
			}
			remove_unit_leader = yes
		}
	}
	hidden_effect = {
		every_unit_leader = {
			limit = {
				OR = {
					is_character = QIE_aisin_gioro_zaitao
					is_character = QIE_aisin_gioro_pujie
					is_character = QIE_aisin_gioro_xiqia
				}
			}
			set_nationality = NSW
		}
	}
}

QIE_tranfer_manchus_to_PREV = {
	every_unit_leader = {
		limit = {
			OR = {
				is_character = QIE_aisin_gioro_zaitao
				is_character = QIE_aisin_gioro_pujie
				is_character = QIE_aisin_gioro_xiqia
			}
		}
		set_nationality = PREV
	}
}

QIEYGD_MORE_POWAH = {
	if = {
		limit = { has_idea = QIE_YGD_legitimacy_1 }
		swap_ideas = {
			remove_idea = QIE_YGD_legitimacy_1
			add_idea = QIE_YGD_legitimacy_2
		}
	}
	else_if = {
		limit = { has_idea = QIE_YGD_legitimacy }
		swap_ideas = {
			remove_idea = QIE_YGD_legitimacy
			add_idea = QIE_YGD_legitimacy_1
		}
	}
	else_if = {
		limit = { has_idea = QIE_YGD_low_legitimacy }
		swap_ideas = {
			remove_idea = QIE_YGD_low_legitimacy
			add_idea = QIE_YGD_legitimacy
		}
	}
	else_if = {
		limit = { has_idea = QIE_YGD_low_legitimacy_2 }
		swap_ideas = {
			remove_idea = QIE_YGD_low_legitimacy_2
			add_idea = QIE_YGD_low_legitimacy
		}
	}
	else = {
		swap_ideas = {
			remove_idea = QIE_YGD_low_legitimacy_3
			add_idea = QIE_YGD_low_legitimacy_2
		}
	}
}
QIE_import_krupp_steel_effect = {
	custom_effect_tooltip = QIE_import_krupp_steel_effect_tt
	set_temp_variable = { QIE_import_krupp_steel_var = party_popularity@market_liberal }
	multiply_temp_variable = { QIE_import_krupp_steel_var = 10 } #Party Pop ranges from 0-1. Multiply it by ten so range is 0-10
	clamp_temp_variable = {
		var = QIE_import_krupp_steel_var
		min = 0
		max = 10
	}
	round_temp_variable = QIE_import_krupp_steel_var
	if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 1 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
	}
	else_if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 2 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		607 = { #Luoyang
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
	}
	else_if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 4 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		607 = { #Luoyang
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		1062 = { #Baoding
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
	}
	else_if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 6 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		607 = { #Luoyang
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		1062 = { #Baoding
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		608 = { #Beijing
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
	}
	else_if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 8 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
		607 = { #Luoyang
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
		1062 = { #Baoding
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
		608 = { #Beijing
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 1
				instant_build = yes
			}
		}
	}
	else_if = {
		limit = { check_variable = { QIE_import_krupp_steel_var < 11 } }
		1048 = { #Wuhan
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
		607 = { #Luoyang
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
		1062 = { #Baoding
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
		608 = { #Beijing
			add_extra_state_shared_building_slots = 1
			add_building_construction = {
				type = industrial_complex
				level = 2
				instant_build = yes
			}
		}
	}
}